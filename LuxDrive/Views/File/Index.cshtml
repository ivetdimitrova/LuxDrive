@model IEnumerable<LuxDrive.Data.Models.File>

@{
    ViewData["Title"] = "LuxDrive Dashboard";

    int totalFiles = Model?.Count() ?? 0;
    int imgCount = Model?.Count(f => f.Extension.Contains("jpg") || f.Extension.Contains("png") || f.Extension.Contains("webp")) ?? 0;
    int vidCount = Model?.Count(f => f.Extension.Contains("mp4") || f.Extension.Contains("avi") || f.Extension.Contains("mov")) ?? 0;
    int docCount = Model?.Count(f => f.Extension.Contains("pdf") || f.Extension.Contains("doc") || f.Extension.Contains("txt")) ?? 0;
    int arcCount = Model?.Count(f => f.Extension.Contains("zip") || f.Extension.Contains("rar") || f.Extension.Contains("7z")) ?? 0;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --gold: #d4af37;
        --gold-glow: rgba(212, 175, 55, 0.4);
        --bg-dark: #050505;
        --card-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.08);
        --text-muted: #888;
        --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    body {
        background-color: var(--bg-dark);
        color: #fff;
        font-family: 'Montserrat', sans-serif;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    .app-wrapper {
        display: flex;
        min-height: 100vh;
        background: radial-gradient(circle at top right, #151515 0%, #000 100%);
        position: relative;
    }

        .app-wrapper::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(198, 166, 100, 0.04) 0%, transparent 60%);
            animation: breathe 15s ease-in-out infinite alternate;
            pointer-events: none;
        }

    @@keyframes breathe {
        0%

    {
        transform: scale(1);
    }

    100% {
        transform: scale(1.1);
    }

    }

    .sidebar {
        width: 260px;
        background: rgba(10, 10, 10, 0.9);
        backdrop-filter: blur(25px);
        border-right: 1px solid var(--glass-border);
        display: flex;
        flex-direction: column;
        padding: 35px 25px;
        position: sticky;
        top: 0;
        height: 100vh;
        z-index: 50;
    }

    .nav-section {
        margin-bottom: 35px;
    }

    .nav-title {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #555;
        letter-spacing: 2px;
        margin-bottom: 15px;
        font-weight: 700;
        padding-left: 10px;
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: #999;
        text-decoration: none;
        border-radius: 12px;
        transition: 0.2s;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.9rem;
    }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(198, 166, 100, 0.08);
            color: var(--gold);
            border-left: 3px solid var(--gold);
        }

    .storage-box {
        margin-top: auto;
        background: linear-gradient(145deg, #151515, #0d0d0d);
        border: 1px solid #222;
        border-radius: 16px;
        padding: 20px;
    }

    .storage-header {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #888;
        margin-bottom: 10px;
    }

    .progress-track {
        height: 6px;
        background: #000;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    .progress-bar {
        width: 45%;
        height: 100%;
        background: var(--gold);
        box-shadow: 0 0 10px var(--gold-glow);
    }

    .upgrade-link {
        display: block;
        text-align: center;
        font-size: 0.8rem;
        color: #fff;
        text-decoration: none;
        font-weight: 600;
    }

    .content {
        flex: 1;
        padding: 40px 50px;
        overflow-y: auto;
        height: 100vh;
        position: relative;
    }

    .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
    }

    .search-bar {
        position: relative;
        width: 420px;
    }

        .search-bar input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border-radius: 100px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: #fff;
            outline: none;
            transition: 0.2s;
        }

            .search-bar input:focus {
                border-color: var(--gold);
                background: #080808;
            }

        .search-bar i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

    .upload-btn {
        background: linear-gradient(135deg, #b88a44, #e6c86e);
        color: #000;
        border: none;
        padding: 12px 35px;
        border-radius: 100px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 20px rgba(198,166,100,0.25);
        transition: 0.4s;
    }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(198,166,100,0.4);
        }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            background: rgba(198,166,100,0.05);
        }

    .stat-info span {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        display: block;
        margin-top: 5px;
    }

    .stat-info h5 {
        margin: 0;
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.85rem;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 15px;
        background: rgba(255,255,255,0.05);
        color: var(--gold);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
    }

    .filter-menu {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .filter-btn {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.1);
        color: #888;
        padding: 8px 24px;
        border-radius: 100px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 0.9rem;
        font-weight: 600;
        white-space: nowrap;
    }

        .filter-btn:hover, .filter-btn.active {
            background: rgba(198,166,100,0.15);
            border-color: var(--gold);
            color: var(--gold);
        }

    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 25px;
        padding-bottom: 80px;
    }

    .file-item {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 15px;
        position: relative;
        transition: 0.4s;
        animation: fadeUp 0.5s backwards;
        display: flex;
        flex-direction: column;
    }

        .file-item:hover {
            transform: translateY(-10px);
            background: rgba(30, 30, 30, 0.6);
            border-color: rgba(198,166,100,0.4);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

    .preview-box {
        width: 100%;
        height: 160px; 
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }

        .preview-box img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; 
            object-position: center !important;
            display: block;
            transition: 0.6s;
        }

    .file-item:hover .preview-box img {
        transform: scale(1.1);
        opacity: 0.8;
    }

    .type-icon {
        font-size: 3.5rem;
        color: #ccc;
        transition: 0.4s;
    }

    .file-item:hover .type-icon {
        color: var(--gold);
        transform: scale(1.15) rotate(5deg);
        text-shadow: 0 0 20px var(--gold-glow);
    }

    .actions-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        opacity: 0;
        transition: 0.3s;
    }

    .file-item:hover .actions-overlay {
        opacity: 1;
    }

    .action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
        transform: translateY(20px);
    }

    .file-item:hover .action-btn {
        transform: translateY(0);
    }

    .action-btn:hover {
        background: var(--gold);
        color: #000;
        border-color: var(--gold);
    }

    .file-info h3 {
        margin: 0;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-info p {
        margin: 5px 0 0;
        font-size: 0.75rem;
        color: #666;
        display: flex;
        justify-content: space-between;
    }

    .check-circle {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 22px;
        height: 22px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        cursor: pointer;
        z-index: 10;
        transition: 0.2s;
    }

    .file-item:hover .check-circle {
        border-color: #fff;
    }

    .check-circle.checked {
        background: var(--gold);
        border-color: var(--gold);
        box-shadow: 0 0 10px var(--gold-glow);
    }

    .bulk-bar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-40%) translateY(100px);
        background: rgba(15, 15, 15, 0.95);
        border: 1px solid var(--gold);
        border-radius: 100px;
        padding: 15px 40px;
        display: flex;
        align-items: center;
        gap: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        z-index: 200;
        transition: 0.4s;
    }

        .bulk-bar.active {
            transform: translateX(-40%) translateY(0);
        }

    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(8px);
        z-index: 1000;
        animation: fadeIn 0.3s;
    }

    .social-hub {
        width: 550px;
        margin: 80px auto;
        background: #111;
        border-radius: 24px;
        border: 1px solid rgba(255,255,255,0.1);
        border-top: 3px solid var(--gold);
        box-shadow: 0 0 80px rgba(198,166,100,0.15);
        overflow: hidden;
        animation: slideUp 0.4s;
    }

    .hub-header {
        padding: 25px 30px;
        border-bottom: 1px solid #222;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .hub-header h2 {
            margin: 0;
            font-size: 1.4rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

    .close-hub {
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
        transition: 0.2s;
    }

        .close-hub:hover {
            color: var(--gold);
            transform: rotate(90deg);
        }

    .hub-tabs {
        display: flex;
        padding: 0 30px;
        background: #0a0a0a;
        border-bottom: 1px solid #222;
    }

    .tab-link {
        flex: 1;
        text-align: center;
        padding: 18px 0;
        background: none;
        border: none;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        transition: 0.3s;
    }

        .tab-link.active {
            color: #fff;
        }

            .tab-link.active::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background: var(--gold);
            }

    .hub-content {
        padding: 30px;
        min-height: 400px;
        max-height: 550px;
        overflow-y: auto;
    }

    .connection-card {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
        background: rgba(255,255,255,0.02);
        transition: 0.2s;
    }

        .connection-card:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(198,166,100,0.3);
        }

    .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #222;
        color: var(--gold);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 15px;
        border: 2px solid #333;
        position: relative;
    }

    .status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: #2ecc71;
        border: 2px solid #1a1a1a;
        border-radius: 50%;
    }

    .user-details {
        flex: 1;
    }

    .user-name {
        display: block;
        font-weight: 600;
        color: #fff;
    }

    .user-email {
        display: block;
        font-size: 0.75rem;
        color: #666;
    }

    .card-tools {
        display: flex;
        gap: 8px;
        opacity: 0;
        transform: translateX(10px);
        transition: 0.3s;
    }

    .connection-card:hover .card-tools {
        opacity: 1;
        transform: translateX(0);
    }

    .tool-btn {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }

        .tool-btn.del {
            background: rgba(255, 92, 92, 0.1);
            color: #ff5c5c;
        }

            .tool-btn.del:hover {
                background: #ff5c5c;
                color: #fff;
            }

    .invite-box {
        background: #080808;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 5px;
        display: flex;
        margin-bottom: 25px;
    }

        .invite-box input {
            flex: 1;
            background: none;
            border: none;
            padding: 15px;
            color: #fff;
            outline: none;
        }

        .invite-box button {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 0 25px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

    .req-card {
        background: #181818;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        border-left: 3px solid var(--gold);
    }

    .req-actions {
        margin-left: auto;
        display: flex;
        gap: 10px;
    }

    .btn-yes {
        background: #2ecc71;
        color: #000;
        border: none;
        padding: 5px 15px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-no {
        background: transparent;
        border: 1px solid #444;
        color: #888;
        padding: 5px 15px;
        border-radius: 6px;
        cursor: pointer;
    }

    @@keyframes slideDown {
        from

    {
        opacity: 0;
        transform: translateY(-20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    @@keyframes slideUp {
        from

    {
        opacity: 0;
        transform: translateY(30px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    @@keyframes fadeUp {
        from

    {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
    }

    to {
        opacity: 1;
    }

    }
</style>

<div class="app-wrapper">

    <aside class="sidebar">
        <div class="nav-section" style="margin-top: 20px;">
            <div class="nav-title">Menu</div>
            <a href="@Url.Action("Index", "Home")" class="nav-item active" onclick="filterFiles(event, 'all')"><i class="fas fa-house"></i> All Files</a>
            <a href="@Url.Action("SharedWithMe", "File")" class="nav-item"><i class="fas fa-share-nodes"></i> Shared</a>
            <a href="#" class="nav-item" onclick="openHub()"><i class="fas fa-user-group"></i> Friends</a>
        </div>

        <div class="nav-section">
            <div class="nav-title">Libraries</div>
            <a href="#" class="nav-item" onclick="filterFiles(event, 'image')"><i class="fas fa-images"></i> Photos</a>
            <a href="#" class="nav-item" onclick="filterFiles(event, 'video')"><i class="fas fa-video"></i> Videos</a>
            <a href="#" class="nav-item" onclick="filterFiles(event, 'document')"><i class="fas fa-file-contract"></i> Documents</a>
            <a href="#" class="nav-item" onclick="filterFiles(event, 'archive')"><i class="fas fa-box-archive"></i> Archives</a>
        </div>

        <div class="storage-box">
            <div class="storage-header"><span>Storage</span><span style="color:var(--gold)">45%</span></div>
            <div class="progress-track"><div class="progress-bar"></div></div>
            <a href="/Pricing" class="upgrade-link">Upgrade Plan</a>
        </div>
    </aside>

    <div class="content">

        <div class="top-header">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search your cloud..." onkeyup="searchFiles(this.value)">
            </div>
            <form asp-controller="File" asp-action="Upload" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <label for="file-upload" class="upload-btn">
                    <i class="fas fa-cloud-arrow-up"></i> Upload
                </label>
                <input type="file" id="file-upload" name="files" multiple style="display:none;" onchange="this.form.submit()" />
            </form>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-info"><h5>All Files</h5><span>@totalFiles</span></div><div class="stat-icon"><i class="fas fa-hard-drive"></i></div></div>
            <div class="stat-card"><div class="stat-info"><h5>Photos</h5><span>@imgCount</span></div><div class="stat-icon"><i class="fas fa-camera"></i></div></div>
            <div class="stat-card"><div class="stat-info"><h5>Videos</h5><span>@vidCount</span></div><div class="stat-icon"><i class="fas fa-film"></i></div></div>
            <div class="stat-card"><div class="stat-info"><h5>Archives</h5><span>@arcCount</span></div><div class="stat-icon"><i class="fas fa-file-zipper"></i></div></div>
        </div>

        <div class="filter-menu">
            <button class="filter-btn active" onclick="filterFiles(event, 'all')">All</button>
            <button class="filter-btn" onclick="filterFiles(event, 'image')">Images</button>
            <button class="filter-btn" onclick="filterFiles(event, 'video')">Videos</button>
            <button class="filter-btn" onclick="filterFiles(event, 'document')">Documents</button>
            <button class="filter-btn" onclick="filterFiles(event, 'archive')">Archives</button>
        </div>

        <div class="files-grid">
            @if (Model != null && Model.Any())
            {
                int delay = 0;
                foreach (var file in Model)
                {
                    string ext = file.Extension?.ToLower() ?? "";
                    string type = "other";
                    string iconClass = "fas fa-file";

                    if (ext.Contains("jpg") || ext.Contains("png") || ext.Contains("webp")) { type = "image"; }
                    else if (ext.Contains("mp4") || ext.Contains("avi")) { type = "video"; iconClass = "fas fa-play"; }
                    else if (ext.Contains("pdf")) { type = "document"; iconClass = "fas fa-file-pdf"; }
                    else if (ext.Contains("doc")) { type = "document"; iconClass = "fas fa-file-word"; }
                    else if (ext.Contains("zip")) { type = "archive"; iconClass = "fas fa-box"; }

                    string delayStyle = $"animation-delay: {delay * 0.05}s;";
                    delay++;

                    <div class="file-item" data-type="@type" style="@delayStyle">
                        <div class="preview-box">
                            <div class="check-circle" onclick="toggleSelect(this, '@file.Id')"></div>
                            @if (type == "image")
                            {
                                <img src="@file.StorageUrl" alt="@file.Name">
                            }
                            else
                            {
                                <i class="@iconClass type-icon"></i>
                            }
                            <div class="actions-overlay">
                                <button class="action-btn" onclick="window.open('@file.StorageUrl')" title="Download"><i class="fas fa-download"></i></button>
                                <button class="action-btn" onclick="openShare('@file.Id')" title="Share"><i class="fas fa-share-alt"></i></button>
                                <button class="action-btn" onclick="deleteFile('@file.Id')" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="file-info">
                            <h3 title="@file.Name">@file.Name</h3>
                            <p><span>@ext.ToUpper()</span> <span>@file.UploadAt.ToString("dd MMM")</span></p>
                            @if (!string.IsNullOrEmpty(file.SenderName))
                            {
                                <p style="color:var(--gold); margin-top:5px;"><i class="fas fa-user-circle"></i> @file.SenderName</p>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#444;">
                    <i class="fas fa-folder-open" style="font-size:3rem; margin-bottom:15px; opacity:0.3"></i><p>It's quiet here. Upload a file to start.</p>
                </div>
            }
        </div>

        <div id="bulkBar" class="bulk-bar">
            <span id="bulkCount" style="color:#fff; font-weight:700;">0 Selected</span>
            <button onclick="bulkShare()" style="background:none; border:none; color:#ccc; cursor:pointer;"><i class="fas fa-share"></i> Share</button>
            <button onclick="bulkDelete()" style="background:none; border:none; color:#ff5c5c; cursor:pointer;"><i class="fas fa-trash"></i> Delete</button>
        </div>
    </div>
</div>

<div id="socialHub" class="modal-overlay">
    <div class="social-hub">
        <div class="hub-header">
            <h2><i class="fas fa-users" style="color:var(--gold)"></i> Friends</h2>
            <div class="close-hub" onclick="closeHub()"><i class="fas fa-times"></i></div>
        </div>
        <div class="hub-tabs">
            <button class="tab-link active" onclick="setTab('connections')">My Friends</button>
            <button class="tab-link" onclick="setTab('add')">Add New</button>
            <button class="tab-link" onclick="setTab('requests')">Requests</button>
        </div>
        <div class="hub-content">
            <div id="view-connections"><div id="connectionsList">Loading...</div></div>
            <div id="view-add" style="display:none;">
                <p style="color:#888; margin-bottom:15px;">Enter email to send an invite:</p>
                <div class="invite-box"><input type="email" id="inviteEmail" placeholder="friend@example.com"><button onclick="sendInvite()">INVITE</button></div>
                <h5 style="color:#666; margin-top:30px; text-transform:uppercase; font-size:0.75rem;">Sent Pending Requests</h5>
                <div id="sentList"></div>
            </div>
            <div id="view-requests" style="display:none;"><div id="requestsList">No new requests.</div></div>
        </div>
    </div>
</div>

<div id="shareModal" class="modal-overlay">
    <div class="social-hub" style="width:400px; margin-top:150px;">
        <div class="hub-header">
            <h2>Share File</h2>
            <div class="close-hub" onclick="closeShare()"><i class="fas fa-times"></i></div>
        </div>
        <div class="hub-content" style="min-height:auto;">
            <input type="hidden" id="shareId">
            <p style="color:#888;">Select recipient:</p>
            <select id="shareSelect" style="width:100%; padding:15px; background:#080808; border:1px solid #333; color:#fff; border-radius:10px; margin:10px 0 20px;"><option>Loading...</option></select>
            <button class="upload-btn" style="width:100%; justify-content:center;" onclick="confirmShare()">Send Now</button>
        </div>
    </div>
</div>

<form id="delForm" asp-controller="File" asp-action="Delete" method="post" style="display:none;">@Html.AntiForgeryToken() <input type="hidden" name="id" id="delId"></form>

<script>
    function filterFiles(e, type) {
        if(e) { document.querySelectorAll('.filter-btn, .nav-item').forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active'); }
        document.querySelectorAll('.file-item').forEach(item => { item.style.display = (type === 'all' || item.dataset.type === type) ? 'block' : 'none'; });
    }
    function searchFiles(txt) {
        txt = txt.toLowerCase();
        document.querySelectorAll('.file-item').forEach(item => { item.style.display = item.querySelector('h3').innerText.toLowerCase().includes(txt) ? 'block' : 'none'; });
    }
    const selection = new Set();
    function toggleSelect(el, id) {
        el.classList.toggle('checked');
        if(el.classList.contains('checked')) selection.add(id); else selection.delete(id);
        const bar = document.getElementById('bulkBar');
        if(selection.size > 0) { bar.classList.add('active'); document.getElementById('bulkCount').innerText = selection.size + " Selected"; } else { bar.classList.remove('active'); }
    }
    function deleteFile(id) { if(confirm("Delete?")) { document.getElementById('delId').value=id; document.getElementById('delForm').submit(); } }
    async function bulkDelete() {
        if(!confirm(`Delete ${selection.size} files?`)) return;
        await fetch('/file/DeleteMultiple', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Array.from(selection))});
        location.reload();
    }
    let isBulk = false;
    function openShare(id) { isBulk=false; document.getElementById('shareId').value=id; document.getElementById('shareModal').style.display='block'; loadShareList(); }
    function bulkShare() { if(!selection.size)return; isBulk=true; document.getElementById('shareModal').style.display='block'; loadShareList(); }
    function closeShare() { document.getElementById('shareModal').style.display='none'; }
    async function loadShareList() {
        const sel = document.getElementById('shareSelect'); sel.innerHTML = '<option>Loading...</option>';
        const r = await fetch('/api/friends/list'); const d = await r.json();
        sel.innerHTML = d.map(f => `<option value="${f.id}">${f.username}</option>`).join('');
    }
    async function confirmShare() {
        const rid = document.getElementById('shareSelect').value;
        if(isBulk) await fetch(`/file/ShareMultiple?receiverId=${rid}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Array.from(selection))});
        else await fetch(`/file/share?fileId=${document.getElementById('shareId').value}&receiverId=${rid}`, {method:'POST'});
        alert("Shared!"); closeShare(); location.reload();
    }
    function openHub() { document.getElementById('socialHub').style.display = 'block'; setTab('connections'); }
    function closeHub() { document.getElementById('socialHub').style.display = 'none'; }
    function setTab(name) {
        document.getElementById('view-connections').style.display = name==='connections'?'block':'none';
        document.getElementById('view-add').style.display = name==='add'?'block':'none';
        document.getElementById('view-requests').style.display = name==='requests'?'block':'none';
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        if(name==='connections') { document.querySelectorAll('.tab-link')[0].classList.add('active'); loadConnections(); }
        if(name==='add') { document.querySelectorAll('.tab-link')[1].classList.add('active'); loadSent(); }
        if(name==='requests') { document.querySelectorAll('.tab-link')[2].classList.add('active'); loadReqs(); }
    }
    async function loadConnections() {
        const c = document.getElementById('connectionsList'); c.innerHTML = '<div style="text-align:center; color:#666;">Loading...</div>';
        try {
            const r = await fetch('/api/friends/list'); const d = await r.json();
            if(!d.length) { c.innerHTML = '<div style="text-align:center; padding:30px; color:#555;">No connections yet. Add someone!</div>'; return; }
            c.innerHTML = d.map(f => `<div class="connection-card"><div class="user-avatar">${f.username[0]}<div class="status-dot"></div></div><div class="user-details"><span class="user-name">${f.username}</span><span class="user-email">${f.email}</span></div><div class="card-tools"><button class="tool-btn del" onclick="removeFriend('${f.id}')"><i class="fas fa-user-minus"></i></button></div></div>`).join('');
        } catch(e) { c.innerHTML = 'Error.'; }
    }
    async function loadReqs() {
        const c = document.getElementById('requestsList');
        const r = await fetch('/api/friends/pending'); const d = await r.json();
        if(!d.length) { c.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">No incoming requests.</div>'; return; }
        c.innerHTML = d.map(q => `<div class="req-card"><div class="user-avatar" style="width:35px; height:35px; font-size:0.9rem;">${q.senderName[0]}</div><div style="margin-left:10px; color:#fff;">${q.senderName}</div><div class="req-actions"><button class="btn-yes" onclick="accept('${q.id}')">Accept</button><button class="btn-no">Ignore</button></div></div>`).join('');
    }
    async function loadSent() {
        const c = document.getElementById('sentList');
        const r = await fetch('/api/friends/sent'); const d = await r.json();
        c.innerHTML = d.length ? d.map(r => `<div style="padding:10px; border-bottom:1px solid #222; display:flex; justify-content:space-between;"><span style="color:#aaa">${r.receiverName}</span><span style="color:var(--gold); font-size:0.8rem;">Pending</span></div>`).join('') : '<span style="color:#555">No active requests.</span>';
    }
    async function sendInvite() {
        const email = document.getElementById('inviteEmail').value;
        if(!email) return;
        const s = await fetch(`/api/friends/search?email=${encodeURIComponent(email)}`);
        if(!s.ok) return alert("User not found.");
        const u = await s.json();
        await fetch(`/api/friends/request?receiverId=${u.id}`, {method:'POST'});
        alert("Invite Sent!"); document.getElementById('inviteEmail').value = ''; loadSent();
    }
    async function removeFriend(id) { if(confirm("Remove connection?")) { await fetch(`/api/friends/remove?friendId=${id}`, {method:'POST'}); loadConnections(); } }
    async function accept(id) { await fetch(`/api/friends/accept?requestId=${id}`, {method:'POST'}); loadReqs(); }
</script>